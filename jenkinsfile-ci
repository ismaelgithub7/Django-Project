pipeline {
    agent {
        label 'develop'
    }
    environment {
        REPO = 'git@github.com:ismaelgithub7/portfolio-DevOps.git'
        RAMA = 'feature/jenkinsfile-ci'
        WORKSPACE = 'django-project develop'
    }
    stages {
        stage('Clonar Repositorio/Rama') {
            steps {
                git branch: ${RAMA}, credentialsId: 'ismael-github', url: ${REPO}
            }
        }

        stage('Comprobar software necesario') {
            steps {
                sh 'docker version > /dev/null'
                sh 'docker compose version > /dev/null'
            }
        }

        stage('Levantar Docker Develop') {
            steps {
                sh 'docker compose -f ./develop/compose-develop.yaml up -d'
                sh "sleep 5"
            }
        }

        stage('Comprobar Acceso Contenedor') {
            steps {
                sh 'docker exec django-develop pwd'
            }
        }

        stage('Comprobar Estado Web') {
            steps {
                sh 'curl -I http://localhost:8000'
            }
        }
        
        stage('Ejecutar Tests') {
            steps {
                sh 'docker exec django-develop python3 manage.py test'
            }
        }
    }

    post {
        success {
            sh 'docker compose -f ./develop/compose-develop.yaml down'
            sh "sudo chown -R jenkins /opt/jenkins/workspace/${WORKSPACE}"
        }

        failure {
            sh 'docker compose -f ./develop/compose-develop.yaml down'
            sh "sudo chown -R jenkins /opt/jenkins/workspace/'django-project develop'"
        }
    }
}
