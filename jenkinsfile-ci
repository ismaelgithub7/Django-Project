pipeline {
    agent {
        label 'develop'
    }
    environment {
        REPO = 'git@github.com:ismaelgithub7/portfolio-DevOps.git'
        RAMA = 'feature/jenkinsfile-ci'
        WORKSPACE = '"django-project develop"'
    }
    stages {
        stage('Clonar Repositorio/Rama') {
            steps {
                git branch: "${RAMA}", credentialsId: 'ismael-github', url: "${REPO}"
            }
        }

        stage('Comprobar Software Necesario') {
            steps {
                sh 'docker version > /dev/null'
                sh 'docker compose version > /dev/null'
            }
        }

        stage('Ejecutar Tests') {
            steps {
                sh 'docker compose -f ./develop/compose-develop.yaml up -d'
                sh "sleep 5"
                sh 'docker exec django-develop python3 manage.py test'
            }
            post {
                success {
                    echo '[SUCCESS] Tests Correctos' 
                    sh 'docker compose -f ./develop/compose-develop.yaml down'
                }
                failure {
                    error 'Tests no pasados con éxito.'
                    sh 'docker compose -f ./develop/compose-develop.yaml down'
                }
            }
        }

        stage('Levantar Dockers Producción') {
            steps {
                sh 'docker compose -f ./production/compose.yaml up -d postgres'
                sh 'docker stop postgres-alpine-production'
                sh 'docker container update --publish-add 5432:5432 postgres-alpine-production'
                sh 'docker start postgres-alpine-production'
                sh 'docker compose -f ./production/compose.yaml up -d django'
                sh 'docker compose -f ./production/compose.yaml up -d nginx-alpine'
                sh './production/docker-data/django/wait-for-it.sh localhost:5432'
            }
        }

        stage('Comprobar Estado Dockers Producción') {
            steps {
                // sh './production/docker-data/django/wait-for-it.sh localhost:80'
                sh 'curl -I http://localhost:80'
            }
            post {
                success {
                    echo '[SUCCSESS] Dockers operativos y listos!!'
                    sh 'docker compose -f ./production/compose.yaml down'
                }
                failure {
                    echo '[ERROR] Ha habido un fallo en la ejecución de los contenedores.'
                    sh 'docker compose -f ./production/compose.yaml down'
                }
            }
        }
        
        // stage('Ejecutar Tests') {
        //     steps {

        //     }
        // }
    }

    post {
        success {
            sh "sudo chown -R jenkins /opt/jenkins/workspace/${WORKSPACE}"
        }

        failure {
            sh "sudo chown -R jenkins /opt/jenkins/workspace/${WORKSPACE}"
        }
    }
}
