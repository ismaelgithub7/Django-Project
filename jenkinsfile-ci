pipeline {
    agent {
        label 'develop'
    }

    stages {
        stage('Clonar repositorio y rama') {
            steps {
                git branch: 'feature/jenkinsfile-ci', credentialsId: 'ismael-github', url: 'git@github.com:ismaelgithub7/portfolio-DevOps.git'
            }
        }

        stage('Comprobar software necesario') {
            steps {
                sh 'pwd'
                sh 'docker version > /dev/null'
                sh 'docker compose version > /dev/null'
            }
        }

        stage('Levantar Docker Develop') {
            steps {
                sh 'docker compose -f ./develop/compose-develop.yaml up -d'
                sh "sleep 5"
            }
        }

        stage('Comprobar Acceso Contenedor') {
            steps {
                sh 'docker exec django-develop python3 version'
            }
        }

        stage('Comprobar Estado Web') {
            steps {
                sh 'curl -I http://localhost:8000'
            }
        }
        
        stage('Ejecutar Tests') {
            steps {
                sh 'python manage.py test'
            }
        }
    }

    post {
        success {
            sh 'docker compose -f ./develop/compose-develop.yaml down'
            sh 'sudo rm -rf /opt/jenkins/workspace/django-project\ develop '
        }

        failure {
            sh 'docker compose -f ./develop/compose-develop.yaml down'
            sh 'sudo rm -rf /opt/jenkins/workspace/"django-project develop"'
        }
    }
}
